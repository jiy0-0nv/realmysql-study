# 5.3 InnoDB 스토리지 엔진 잠금

- InnoDB는 스토리지 엔진 내부에서 레코드 기반 잠금 방식을 제공

- 레코드 단위 잠금으로 MyISAM 대비 높은 동시성 처리 가능

- 잠금 정보는 엔진 내부 구조에 저장, 에스컬레이션 발생 X

---

## 5.3.1 InnoDB 스토리지 엔진의 잠금

### 잠금의 기본 성격

- 레코드 잠금 정보가 매우 compact하게 관리
  - 페이지 락 -> 테이블 락으로 승격되는 락 에스컬레이션이 없음

- 대부분의 잠금은 인덱스 레코드 기준으로 설정 
  - 테이블에 인덱스가 없어도 내부 클러스터 인덱스 기준으로 잠금 수행

### 잠금 종류와 목적

| 잠금 종류 | 대상 | 주요 목적 | 특징 |
|---|---|---|---|
| 레코드 락 | 특정 인덱스 레코드 | 선택된 레코드의 변경 직렬화 | PK·유니크 인덱스 기반 변경 시 갭은 잠그지 않음 |
| 갭 락 | 레코드와 레코드 사이의 간격 | 간격 내 새로운 레코드 생성(INSERT) 차단 | 팬텀 삽입 방지 목적 |
| 넥스트 키 락 | 레코드 락 + 갭 락 | 검색 범위 내 변경의 재현성 보장 | REPEATABLE READ에서 주로 사용 |
| 자동 증가 락 | 테이블 단위 | AUTO_INCREMENT 값의 순차/유일성 확보 | 매우 짧게 획득/해제되는 경량 잠금 |

#### 레코드 락

- 실제 “행”이 아니라 **인덱스 레코드**를 잠그는 방식
- PK 또는 유니크 인덱스 조건으로 정확히 한 건을 찾는 변경은 갭 없이 레코드만 잠금

#### 갭 락

- 레코드 사이 **간격**만을 잠금
- 간격 내 새로운 삽입을 막아 팬텀 문제를 억제

#### 넥스트 키 락

- 레코드 락과 갭 락의 결합 형태


#### 자동 증가 락
- INSERT/REPLACE 시 `AUTO_INCREMENT` 값을 배정하는 매우 짧은 구간에만 획득



---

## 5.3.2 인덱스와 잠금

- InnoDB는 **변경 대상 레코드를 찾기 위해 탐색한 인덱스 레코드들**에 잠금을 설정
- 적절한 인덱스가 없으면 필요 이상으로 많은 레코드가 잠김 -> 동시성 급격 저하 위험



## 5.3.3 레코드 수준 잠금 확인 및 해제


1. 프로세스 상태 확인  
   - {SHOW PROCESSLIST}로 대기 중 세션과 실행 중 세션을 식별

2. 잠금 대기 체인 조회  
   - 누가 누구를 막고 있는지 **대기 -> 차단** 관계를 가시화

3. 잠금 상세 확인  

4. 강제 해제  
   - 장시간 보류 세션은 `{KILL <thread_id>}`로 종료하여 교착/장기 대기를 해소

