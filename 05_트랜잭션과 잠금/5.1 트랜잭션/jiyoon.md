# 5.1 트랜잭션

- 트랜잭션은 논리적 작업 단위를 완전 적용 또는 원상 복구하는 메커니즘이다.
- `COMMIT` / `ROLLBACK` -> 일관성 보장
- 잠금: 동시성 제어, 트랜잭션: 정합성 보장

## 5.1.1 MySQL에서의 트랜잭션

- 단일 쿼리이든 다중 쿼리이든 작업 셋 전체가 100% 적용되거나 전혀 적용되지 않음을 보장한다. 
- MyISAM, MEMORY는 트랜잭션 미지원 / InnoDB는 지원함
   
  - e.g., `autocommit=ON` 상태에서 `PRIMARY KEY` 중복을 유발하는 다중 `INSERT` 실행

    |MyISAM | InnoDB |
    |---|---|
    | 오류 발생하나 선행 `1,2`는 남아 부분 적용이 발생 | 오류 발생 시 전체 작업을 원상 복구 |
    | 부분 업데이트 발생으로 정합성 위험 증가 | 트랜잭션 원칙에 따라 원자성을 보장 |

    - MyISAM은 오류가 나도 이미 삽입된 `1,2`가 남아 부분 업데이트 발생함
    
    - InnoDB는 일부라도 오류가 나면 전체를 실행 전 상태로 복구

- 이러한 부분 업데이트는 테이블 정합성 유지에 큰 어려움을 유발
- 실패한 작업의 잔여 레코드를 제거해야 함 -> 복잡한 재처리 로직이 필요

- e.g., 트랜잭션 미사용 시의 복잡한 보정 흐름

    1. `INSERT tab_a ...`
    2. 성공 여부 확인
    3. `INSERT tab_b ...`
    4. 실패 시 `DELETE tab_a ...`
    5. 삭제 성공 여부까지 별도 처리 필요 

- e.g., 트랜잭션 사용 시 단순화

    ```sql
    try {
        START TRANSACTION;
        INSERT tab_a ...;
        INSERT tab_b ...;
        COMMIT;
    } catch {
        ROLLBACK;
    }
    ```



## 5.1.2 주의사항

### 핵심 원칙

- 트랜잭션 범위는 꼭 필요한 최소 코드로 한정
  
  - 실제 데이터 저장이 시작되는 구간에서 트랜잭션을 시작
  - 가능한 빨리 종료

### 네트워크·외부 I/O 배제

- 네트워크 작업(메일 전송, FTP, 원격 서버 통신 등)은 트랜잭션 외부로 배치
- 네트워크 문제로 웹 서버뿐 아니라 DBMS까지 위험해질 수 있음 

### 작업 성격별 트랜잭션 분리

- 쓰기 작업 묶기
  - 사용자 입력 저장 + 첨부 메타 저장

- 조회 작업 분리
  - 저장 내용 확인 같은 단순 조회는 트랜잭션 포함 불필요

- 후속 기록 분리
  - 알림 발송 이력 저장은 별도 트랜잭션으로 분리 가능

### 권장 처리 절차 예시

1. 전처리 단계에서 로그인 확인, 입력 검증, 파일 저장을 먼저 수행

2. 커넥션 생성 및 `START TRANSACTION`으로 본 저장 트랜잭션 시작
 
3. 본문 저장과 첨부 정보 저장 후 즉시 `COMMIT`

4. 조회 수행 및 알림 발송은 트랜잭션 외부에서 처리

5. 알림 발송 이력 저장은 별도 트랜잭션으로 수행 

### 트랜잭션 범위 설계 도표

| 작업 | 권장 위치 | 이유 |
|---|---|---|
| 로그인 확인·입력 검증·파일 업로드 | 트랜잭션 외부 | 커넥션·락 점유 시간 단축 및 실패 시 재시도 용이  |
| 본문 저장 + 첨부 메타 저장 | 한 트랜잭션으로 묶음 | 원자성 확보 및 부분 업데이트 방지  |
| 저장 내용 확인 조회 | 트랜잭션 외부 | 읽기 확인에 트랜잭션 불필요  |
| 알림 발송(메일·푸시 등) | 트랜잭션 외부 | 네트워크 불확실성으로 인한 DBMS 위험 차단  |
| 알림 발송 이력 저장 | 별도 트랜잭션 | 본 저장과 독립적 커밋 단위로 관리  |



## Tips

- `START TRANSACTION`은 실제 쓰기 직전에 시작

- 외부 통신이 하나라도 개입되면 트랜잭션에서 분리

- 다중 쓰기는 한 트랜잭션으로 묶고 조회는 분리

- 오류 처리 경로에서는 `ROLLBACK`으로 일관성 있게 정리

- 가능하면 InnoDB 사용
